{% extends "base.html" %}
{% block title %}Rent a Car{% endblock %}
{% block content %}

<section class="rent-car-section py-5">
  <div class="container">
    <div class="text-center mb-5">
      <h1 class="fw-bold text-gradient">ðŸš— Rent a Car</h1>
      <p class="text-muted lead">Choose from a range of cars to make your journey smooth and comfortable.</p>
    </div>

    <!--  Filter Section -->
    <div class="filter-bar shadow-sm p-4 rounded-4 mb-5">
      <form method="GET" class="row g-3 align-items-center">
        <div class="col-md-4">
          <input type="text" name="pickup_location" class="form-control" placeholder="Enter pickup city" required>
        </div>
        <div class="col-md-3">
          <input type="date" name="start_date" id="start_date" class="form-control" required>
        </div>
        <div class="col-md-3">
          <input type="date" name="end_date" id="end_date" class="form-control" required>
        </div>
        <div class="col-md-2 d-grid">
          <button type="submit" class="btn btn-gradient-blue fw-bold">Search</button>
        </div>
      </form>
    </div>

    <!--  Available Cars -->
    <div class="row g-4">
      {% if cars %}
        {% for car in cars %}
        <div class="col-lg-4 col-md-6">
          <div class="card car-card shadow-lg border-0 animate-in">
            <div class="car-image-wrapper">
              {% if car.name == 'Toyota Innova' %}
              <img src="{{ url_for('static', filename='img/innova.jpg') }}" class="card-img-top" alt="{{ car.name }}">
              {% elif car.name == 'Hyundai i20' %}
                <img src="{{ url_for('static', filename='img/i20.jpg') }}" class="card-img-top" alt="{{ car.name }}">
              {% elif car.name == 'Maruti Swift Dzire' %}
                <img src="{{ url_for('static', filename='img/swift-dzire.jpg') }}" class="card-img-top" alt="{{ car.name }}">
              {% elif car.name == 'Honda City' %}
                <img src="{{ url_for('static', filename='img/honda-city.jpg') }}" class="card-img-top" alt="{{ car.name }}">
              {% elif car.name == 'Kia Seltos' %}
                <img src="{{ url_for('static', filename='img/kia-seltos.jpg') }}" class="card-img-top" alt="{{ car.name }}">
              {% elif car.name == 'Mercedes-Benz E-Class' %}
                <img src="{{ url_for('static', filename='img/mercedes-eclass.jpg') }}" class="card-img-top" alt="{{ car.name }}">
              {% elif car.name == 'BMW 5 Series' %}
                <img src="{{ url_for('static', filename='img/bmw5-yellow.jpg') }}" class="card-img-top" alt="{{ car.name }}">
              {% elif car.name == 'Audi A6' %}
                <img src="{{ url_for('static', filename='img/audi-a6.jpg') }}" class="card-img-top" alt="{{ car.name }}">
              {% elif car.name == 'Porsche 911 Carrera' %}
                <img src="{{ url_for('static', filename='img/porsche-911.jpg') }}" class="card-img-top" alt="{{ car.name }}">
              {% elif car.name == 'Jaguar F-Type' %}
                <img src="{{ url_for('static', filename='img/jaguar-ftype.jpg') }}" class="card-img-top" alt="{{ car.name }}">
              {% elif car.name == 'Lamborghini HuracÃ¡n EVO' %}
                <img src="{{ url_for('static', filename='img/lamborghini-huracan.jpg') }}" class="card-img-top" alt="{{ car.name }}">
              {% elif car.name == 'Range Rover Sport' %}
                <img src="{{ url_for('static', filename='img/range-rover-sport.jpg') }}" class="card-img-top" alt="{{ car.name }}">
              {% elif car.name == 'Toyota Fortuner Legender' %}
                <img src="{{ url_for('static', filename='img/fortuner-legender.jpg') }}" class="card-img-top" alt="{{ car.name }}">
              {% else %}
                <img src="{{ url_for('static', filename='img/car-default.jpg') }}" class="card-img-top" alt="{{ car.name }}">
              {% endif %}

              <div class="price-tag">â‚¹{{ car.price_per_day }}/day</div>
            </div>
            <div class="card-body">
              <h5 class="fw-bold">{{ car.name }}</h5>
              <p class="text-muted mb-2"><i class="bi bi-geo-alt-fill text-primary"></i> {{ car.pickup_location }}</p>
              <div class="car-specs mb-3">
                <span><i class="bi bi-people-fill text-info"></i> {{ car.seats }} Seats</span>
                <span><i class="bi bi-gear-fill text-warning"></i> {{ car.transmission }}</span>
                <span><i class="bi bi-snow text-primary"></i> {{ car.ac_type }}</span>
              </div>
              <div class="d-flex justify-content-between align-items-center">
                <span class="rating text-warning"><i class="bi bi-star-fill"></i> {{ car.rating or '4.5' }}</span>
                <button type="button" class="btn btn-gradient-orange btn-sm fw-bold" data-bs-toggle="modal" data-bs-target="#bookingModal" data-car-id="{{ car.id }}" data-car-name="{{ car.name }}" data-car-price="{{ car.price_per_day }}">Book Now</button>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      {% else %}
      <div class="text-center py-5">
        <img src="{{ url_for('static', filename='img/no-data.svg') }}" width="200" class="mb-3" alt="No Cars">
        <h4 class="fw-bold">No Cars Found</h4>
        <p class="text-muted">Try a different location or date range.</p>
      </div>
      {% endif %}
    </div>
  </div>
</section>

<!--  Booking Modal -->
<div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="bookingForm">
        <div class="modal-header">
          <h5 class="modal-title" id="bookingModalLabel">Book Car</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="car_id" id="modal_car_id">
          <input type="hidden" name="car_price" id="modal_car_price">
          <div class="mb-3">
            <label for="user_name" class="form-label">Full Name</label>
            <input type="text" name="user_name" id="user_name" class="form-control" required pattern="[A-Za-z\s]{3,}">
          </div>
          <div class="mb-3">
            <label for="user_phone" class="form-label">Mobile Number (+91 required)</label>
            <input type="text" name="user_phone" id="user_phone" class="form-control" required pattern="^\+91[0-9]{10}$" placeholder="+919876543210">
          </div>
          <div class="mb-3">
            <label for="license_no" class="form-label">Driving License Number</label>
            <input type="text" name="license_no" id="license_no" class="form-control" required pattern="[A-Z0-9]{6,15}">
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="start_date_modal" class="form-label">Start Date</label>
              <input type="date" name="start_date" id="start_date_modal" class="form-control" required>
            </div>
            <div class="col-md-6 mb-3">
              <label for="end_date_modal" class="form-label">End Date</label>
              <input type="date" name="end_date" id="end_date_modal" class="form-control" required>
            </div>
          </div>
          
          <!-- Price Calculation -->
          <div class="card bg-light mt-3">
            <div class="card-body">
              <h6 class="card-title">ðŸ’° Price Summary</h6>
              <div class="d-flex justify-content-between">
                <span>Price per day:</span>
                <span>â‚¹<span id="display_car_price">0</span></span>
              </div>
              <div class="d-flex justify-content-between">
                <span>Number of days:</span>
                <span id="days_count">0</span>
              </div>
              <hr>
              <div class="d-flex justify-content-between fw-bold">
                <span>Total Amount:</span>
                <span class="text-success">â‚¹<span id="total_amount">0</span></span>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-success w-100" id="payButton">ðŸ’³ Pay Now - â‚¹<span id="pay_amount">0</span></button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Razorpay Payment Script -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const today = new Date().toISOString().split("T")[0];
  document.getElementById("start_date").min = today;
  document.getElementById("end_date").min = today;

  const modalStart = document.getElementById("start_date_modal");
  const modalEnd = document.getElementById("end_date_modal");
  modalStart.min = today;
  modalEnd.min = today;

  let carPrice = 0;
  let totalAmount = 0;

  // Calculate days and total amount
  function calculateTotal() {
    const startDate = new Date(modalStart.value);
    const endDate = new Date(modalEnd.value);
    
    if (modalStart.value && modalEnd.value && startDate <= endDate) {
      const timeDiff = endDate.getTime() - startDate.getTime();
      const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24)) + 1; // Include both start and end day
      document.getElementById('days_count').textContent = daysDiff;
      
      totalAmount = carPrice * daysDiff;
      document.getElementById('total_amount').textContent = totalAmount;
      document.getElementById('pay_amount').textContent = totalAmount;
    } else {
      document.getElementById('days_count').textContent = '0';
      document.getElementById('total_amount').textContent = '0';
      document.getElementById('pay_amount').textContent = '0';
      totalAmount = 0;
    }
  }

  modalStart.addEventListener("change", () => {
    modalEnd.min = modalStart.value;
    if (modalEnd.value < modalStart.value) modalEnd.value = modalStart.value;
    calculateTotal();
  });

  modalEnd.addEventListener("change", calculateTotal);

  // Transfer car data to modal
  const bookingModal = document.getElementById('bookingModal');
  bookingModal.addEventListener('show.bs.modal', event => {
    const button = event.relatedTarget;
    const carId = button.getAttribute('data-car-id');
    const carName = button.getAttribute('data-car-name');
    carPrice = parseInt(button.getAttribute('data-car-price'));
    
    document.getElementById('modal_car_id').value = carId;
    document.getElementById('modal_car_price').value = carPrice;
    document.getElementById('display_car_price').textContent = carPrice;
    document.getElementById('bookingModalLabel').textContent = `Book ${carName}`;
    
    // Reset form
    document.getElementById('user_name').value = '';
    document.getElementById('user_phone').value = '';
    document.getElementById('license_no').value = '';
    modalStart.value = '';
    modalEnd.value = '';
    calculateTotal();
  });

  // Razorpay Payment Integration
  document.getElementById('payButton').addEventListener('click', async function(e) {
    e.preventDefault();

    // Validate form
    const form = document.getElementById('bookingForm');
    if (!form.checkValidity()) {
      form.reportValidity();
      return;
    }

    const userPhone = document.getElementById('user_phone').value;
    if (!userPhone.startsWith("+91") || userPhone.length !== 13) {
      alert("Please enter a valid Indian mobile number starting with +91.");
      return;
    }

    if (totalAmount <= 0) {
      alert("Please select valid dates to calculate total amount.");
      return;
    }

    // Show loading state
    const payButton = document.getElementById('payButton');
    payButton.disabled = true;
    payButton.textContent = 'Processing Payment...';

    try {
      // Create order on server
      const response = await fetch("/create_car_order", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          amount: totalAmount,
          car_id: document.getElementById('modal_car_id').value,
          car_name: document.getElementById('bookingModalLabel').textContent.replace('Book ', '')
        })
      });

      const orderData = await response.json();

      if (!response.ok) {
        throw new Error(orderData.error || "Failed to create order");
      }

      // Razorpay checkout options
      const options = {
        key: orderData.key,
        amount: orderData.amount,
        currency: "INR",
        name: "TravelBuddy Car Rental",
        description: "Car Rental Booking",
        order_id: orderData.order_id,
        handler: function(response) {
          // Payment successful - submit the form to server
          const formData = new FormData();
          formData.append('car_id', document.getElementById('modal_car_id').value);
          formData.append('user_name', document.getElementById('user_name').value);
          formData.append('user_phone', document.getElementById('user_phone').value);
          formData.append('license_no', document.getElementById('license_no').value);
          formData.append('start_date', document.getElementById('start_date_modal').value);
          formData.append('end_date', document.getElementById('end_date_modal').value);
          formData.append('razorpay_payment_id', response.razorpay_payment_id);
          formData.append('razorpay_order_id', response.razorpay_order_id);
          formData.append('razorpay_signature', response.razorpay_signature);

          fetch("/book_car", {
            method: "POST",
            body: formData
          })
          .then(res => {
            if (res.ok) {
              window.location.href = "/my_car_rentals";
            } else {
              throw new Error('Booking failed');
            }
          })
          .catch(error => {
            console.error('Booking error:', error);
            alert('Booking failed. Please try again.');
          });
        },
        prefill: {
          name: document.getElementById('user_name').value,
          email: "{{ session.user_email }}",
          contact: document.getElementById('user_phone').value
        },
        theme: {
          color: "#3399cc"
        },
        modal: {
          ondismiss: function() {
            // Reset button if payment is cancelled
            payButton.disabled = false;
            payButton.innerHTML = 'ðŸ’³ Pay Now - â‚¹<span id="pay_amount">' + totalAmount + '</span>';
          }
        }
      };

      const rzp = new Razorpay(options);
      rzp.open();

    } catch (error) {
      console.error("Payment error:", error);
      alert("Payment initialization failed: " + error.message);
      
      // Reset button state
      payButton.disabled = false;
      payButton.innerHTML = 'ðŸ’³ Pay Now - â‚¹<span id="pay_amount">' + totalAmount + '</span>';
    }
  });
});
</script>

{% endblock %}