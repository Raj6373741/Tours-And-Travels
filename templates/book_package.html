{% extends "base.html" %}
{% block title %}Book Package - {{ package.package_name }}{% endblock %}
{% block content %}

<div class="container my-5">
    <div class="row">
        <!-- Package Details -->
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">{{ package.package_name }}</h4>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>üìç Location:</strong> {{ package.location }} ({{ package.region }})
                    </div>
                    <div class="mb-3">
                        <strong>‚è±Ô∏è Duration:</strong> {{ package.duration }}
                    </div>
                    <div class="mb-3">
                        <strong>‚≠ê Popular Attraction:</strong> {{ package.popular_attraction }}
                    </div>
                    <div class="mb-3">
                        <strong>üìù Description:</strong> {{ package.description }}
                    </div>
                    <div class="mb-3">
                        <strong>‚úàÔ∏è Nearest Airport:</strong> {{ package.nearest_airport }}
                    </div>
                    <div class="mb-3">
                        <strong>üöÜ Nearest Railway:</strong> {{ package.nearest_railway }}
                    </div>
                    <div class="mb-3">
                        <strong>üí∞ Price per person:</strong> 
                        <span class="h5 text-success">‚Çπ{{ package.price }}</span>
                        {% if package.old_price %}
                        <small class="text-decoration-line-through text-muted ms-2">‚Çπ{{ package.old_price }}</small>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Booking Form -->
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-warning text-dark">
                    <h4 class="mb-0">Book This Package</h4>
                </div>
                <div class="card-body">
                    <form method="POST" id="bookingForm">
                        <div class="mb-3">
                            <label class="form-label"><strong>üìÖ Booking Date</strong></label>
                            <input type="date" name="booking_date" class="form-control" required 
                                   min="{{ today }}">
                        </div>

                        <div class="mb-3">
                            <label class="form-label"><strong>üë• Group Size</strong></label>
                            <input type="number" name="group_size" id="group_size" class="form-control" 
                                   min="1" max="20" value="1" required>
                        </div>

                        <!-- Traveler Details Container -->
                        <div id="travelerContainer"></div>

                        <!-- Price Summary -->
                        <div class="card mt-4 bg-light">
                            <div class="card-body">
                                <h5 class="card-title">üí∞ Price Summary</h5>
                                <div class="d-flex justify-content-between">
                                    <span>Price per person:</span>
                                    <span>‚Çπ<span id="pricePerPerson">{{ package.price }}</span></span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>Number of travelers:</span>
                                    <span id="travelerCount">1</span>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between fw-bold fs-5">
                                    <span>Total Amount:</span>
                                    <span class="text-success">‚Çπ<span id="totalAmount">{{ package.price }}</span></span>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Button -->
                        <div class="d-grid mt-4">
                            <button type="button" class="btn btn-success btn-lg" id="payButton">
                                üí≥ Pay Now - ‚Çπ<span id="payAmount">{{ package.price }}</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Razorpay Payment Script -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const groupSizeInput = document.getElementById('group_size');
    const travelerContainer = document.getElementById('travelerContainer');
    const pricePerPersonSpan = document.getElementById('pricePerPerson');
    const travelerCountSpan = document.getElementById('travelerCount');
    const totalAmountSpan = document.getElementById('totalAmount');
    const payAmountSpan = document.getElementById('payAmount');
    const payButton = document.getElementById('payButton');
    const bookingForm = document.getElementById('bookingForm');

    const pricePerPerson = {{ package.price }};

    // Set minimum date to today
    const today = new Date().toISOString().split('T')[0];
    document.querySelector('input[name="booking_date"]').setAttribute('min', today);

    // Update traveler fields and calculate total
    function updateTravelerFields() {
        const groupSize = parseInt(groupSizeInput.value) || 1;
        travelerContainer.innerHTML = '';

        for (let i = 1; i <= groupSize; i++) {
            const travelerHtml = `
                <div class="card mb-3 traveler-group">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">Traveler ${i}</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <input type="text" class="form-control traveler-name" 
                                       name="traveler_name_${i}" placeholder="Full Name" required>
                            </div>
                            <div class="col-md-3 mb-2">
                                <input type="number" class="form-control traveler-age" 
                                       name="traveler_age_${i}" placeholder="Age" min="1" max="120" required>
                            </div>
                            <div class="col-md-3 mb-2">
                                <input type="tel" class="form-control traveler-phone" 
                                       name="traveler_phone_${i}" placeholder="Phone" required>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            travelerContainer.innerHTML += travelerHtml;
        }

        // Update prices
        const totalAmount = groupSize * pricePerPerson;
        totalAmountSpan.textContent = totalAmount;
        payAmountSpan.textContent = totalAmount;
        travelerCountSpan.textContent = groupSize;
    }

    // Initial setup
    updateTravelerFields();

    // Update on group size change
    groupSizeInput.addEventListener('change', updateTravelerFields);
    groupSizeInput.addEventListener('input', updateTravelerFields);

    // Razorpay Payment Integration
    payButton.addEventListener('click', async function(e) {
        e.preventDefault();

        // Validate form
        if (!bookingForm.checkValidity()) {
            bookingForm.reportValidity();
            return;
        }

        const groupSize = parseInt(groupSizeInput.value) || 1;
        const totalAmount = groupSize * pricePerPerson;

        if (totalAmount <= 0) {
            alert('Please enter valid group size');
            return;
        }

        // Show loading state
        payButton.disabled = true;
        payButton.textContent = 'Processing Payment...';

        try {
            // Create order on server
            const response = await fetch("/create_package_order", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    amount: totalAmount,
                    package_id: {{ package.id }},
                    package_name: "{{ package.package_name }}"
                })
            });

            const orderData = await response.json();

            if (!response.ok) {
                throw new Error(orderData.error || "Failed to create order");
            }

            // Razorpay checkout options
            const options = {
                key: orderData.key,
                amount: orderData.amount,
                currency: "INR",
                name: "TravelBuddy Tour Packages",
                description: "{{ package.package_name }}",
                order_id: orderData.order_id,
                handler: function(response) {
                    // Payment successful - submit the form
                    const paymentIdInput = document.createElement("input");
                    paymentIdInput.type = "hidden";
                    paymentIdInput.name = "razorpay_payment_id";
                    paymentIdInput.value = response.razorpay_payment_id;
                    bookingForm.appendChild(paymentIdInput);

                    const orderIdInput = document.createElement("input");
                    orderIdInput.type = "hidden";
                    orderIdInput.name = "razorpay_order_id";
                    orderIdInput.value = response.razorpay_order_id;
                    bookingForm.appendChild(orderIdInput);

                    const signatureInput = document.createElement("input");
                    signatureInput.type = "hidden";
                    signatureInput.name = "razorpay_signature";
                    signatureInput.value = response.razorpay_signature;
                    bookingForm.appendChild(signatureInput);

                    // Submit the form
                    bookingForm.submit();
                },
                prefill: {
                    name: document.querySelector('.traveler-name')?.value || '',
                    email: "{{ session.user_email }}",
                    contact: document.querySelector('.traveler-phone')?.value || ''
                },
                theme: {
                    color: "#3399cc"
                },
                modal: {
                    ondismiss: function() {
                        // Reset button if payment is cancelled
                        payButton.disabled = false;
                        payButton.innerHTML = `üí≥ Pay Now - ‚Çπ<span id="payAmount">${totalAmount}</span>`;
                    }
                }
            };

            const rzp = new Razorpay(options);
            rzp.open();

        } catch (error) {
            console.error("Payment error:", error);
            alert("Payment initialization failed: " + error.message);
            
            // Reset button state
            payButton.disabled = false;
            payButton.innerHTML = `üí≥ Pay Now - ‚Çπ<span id="payAmount">${totalAmount}</span>`;
        }
    });
});
</script>

{% endblock %}